<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Native Reference Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!DOCTYPE html>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css">
<link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css">
<link rel="stylesheet" type="text/css"
      href="stylesheet/config.css">
<link rel="stylesheet" type="text/css"
      href="stylesheet/asciidoc-tabs.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/js/patternfly.min.js"></script>
<script src="javascript/config.js"></script>
<script src="javascript/asciidoc-tabs.js"></script>

<style>
    .book {
        font-size: 14px;
    }

    .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title,
    .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title,
    .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title,
    .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
        font-size: 1.6rem;
    }

    p, blockquote, dt, td.content, span.alt, .quoteblock blockquote, .quoteblock blockquote p {
        font-size: 1.6rem;
    }

    pre code {
        font-size: 1.5rem;
    }

    #preamble>.sectionbody>[class="paragraph"]:first-of-type p {
        font-size: 1.6rem;
    }

    #header, #content, #footer, #footnotes {
        max-width: 72em;
    }
</style>
</head>
<body class="article">
<div id="header">
<h1>Native Reference Guide</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide is a companion to the
<a href="building-native-image.html">Building a Native Executable</a>,
<a href="native-and-ssl.html">Using SSL With Native Images</a>,
and <a href="writing-native-applications-tips.html">Writing Native Applications</a>,
guides.
It provides further details to debugging issues in Quarkus native executables that might arise during development or production.</p>
</div>
<div class="paragraph">
<p>This reference guide takes as input the application developed in the <a href="getting-started.html">Getting Started Guide</a>.
You can find instructions on how to quickly set up this application in this guide.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements-and-assumptions"><a class="anchor" href="#requirements-and-assumptions"></a>Requirements and Assumptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide has the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 11 installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p>Apache Maven 3.8.4</p>
</li>
<li>
<p>A working container runtime (Docker, podman)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide builds and executes Quarkus native executables within a Linux environment.
To offer a homogeneous experience across all environments,
the guide relies on a container runtime environment to build and run the native executables.
The instructions below use Docker as example, but very similar commands should work on alternative container runtimes, e.g. podman.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Building native executables is an expensive process,
so make sure the container runtime has enough CPU and memory to do this.
A minimum of 4 CPUs and 4GB of memory is required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, this guide assumes the use of the <a href="https://github.com/graalvm/mandrel">Mandrel distribution</a> of GraalVM for building native executables,
and these are built within a container so there is no need for installing Mandrel on the host.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bootstrapping-the-project"><a class="anchor" href="#bootstrapping-the-project"></a>Bootstrapping the project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start by creating a new Quarkus project.
Open a terminal and run the following command:</p>
</div>
<div class="paragraph">
<p>For Linux &amp; MacOS users</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">CLI</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">quarkus create app org.acme:debugging-native \
    --extension=resteasy,container-image-docker
cd debugging-native</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>--gradle</code> or <code>--gradle-kotlin-dsl</code> option.</p>
</div>
<div class="paragraph">
<p><em>For more information about how to install the Quarkus CLI and use it, please refer to <a href="cli-tooling.html">the Quarkus CLI guide</a>.</em></p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:999-SNAPSHOT:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=debugging-native \
    -Dextensions="resteasy,container-image-docker"
cd debugging-native</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>-DbuildTool=gradle</code> or <code>-DbuildTool=gradle-kotlin-dsl</code> option.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>For Windows users</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If using cmd , (don&#8217;t use backward slash <code>\</code> and put everything on the same line)</p>
</li>
<li>
<p>If using Powershell , wrap <code>-D</code> parameters in double quotes e.g. <code>"-DprojectArtifactId=debugging-native"</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-quarkus-properties"><a class="anchor" href="#configure-quarkus-properties"></a>Configure Quarkus properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some Quarkus configuration options will be used constantly throughout this guide,
so to help declutter command line invocations,
it&#8217;s recommended to add these options to the <code>application.properties</code> file.
So, go ahead and add the following options to that file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">quarkus.native.container-build=true
quarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel:22.0-java11
quarkus.container-image.build=true
quarkus.container-image.group=test</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="first-debugging-steps"><a class="anchor" href="#first-debugging-steps"></a>First Debugging Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a first step, change to the project directory and build the native executable for the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the application to verify it works as expected. In one terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT</code></pre>
</div>
</div>
<div class="paragraph">
<p>In another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -w '\n' http://localhost:8080/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of this section explores ways to build the native executable with extra information,
but first, stop the running application.
We can obtain this information while building the native executable by adding additional native-image build options using <code>-Dquarkus.native.additional-build-args</code>, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.additional-build-args=--native-image-info</code></pre>
</div>
</div>
<div class="paragraph">
<p>Executing that will produce additional output lines like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">...
# Printing compilation-target information to: /project/reports/target_info_20220223_100915.txt
…
# Printing native-library information to: /project/reports/native_library_info_20220223_100925.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>The target info file contains information such as the target platform,
the toolchain used to compile the executable,
and the C library in use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ cat target/*/reports/target_info_*.txt
Building image for target platform: org.graalvm.nativeimage.Platform$LINUX_AMD64
Using native toolchain:
   Name: GNU project C and C++ compiler (gcc)
   Vendor: redhat
   Version: 8.5.0
   Target architecture: x86_64
   Path: /usr/bin/gcc
Using CLibrary: com.oracle.svm.core.posix.linux.libc.GLib</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native library info file contains information on the static libraries added to the binary and the other libraries dynamically linked to the executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ cat target/*/reports/native_library_info_*.txt
Static libraries:
   ../opt/mandrel/lib/svm/clibraries/linux-amd64/liblibchelper.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libnet.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libextnet.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libnio.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libjava.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libfdlibm.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libsunec.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libzip.a
   ../opt/mandrel/lib/svm/clibraries/linux-amd64/libjvm.a
Other libraries: stdc++,pthread,dl,z,rt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even more detail can be obtained by passing in <code>--verbose</code> as an additional native-image build argument.
This option can be very useful in detecting whether the options that you pass at a high level via Quarkus are being passed down to the native executable production,
or whether some third party jar has some native-image configuration embedded in it that is reaching the native-image invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.additional-build-args=--verbose</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running with <code>--verbose</code> demonstrates how the native-image building process is two sequential java processes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first is a very short Java process that does some basic validation and builds the arguments for the second process
(in a stock GraalVM distribution, this is executed as native code).</p>
</li>
<li>
<p>The second Java process is where the main part of the native executable production happens.
The <code>--verbose</code> option shows the actual Java process executed.
You could take the output and run it yourself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One may also combine multiple native build options by separating with a comma, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.additional-build-args=--native-image-info,--verbose</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that if an argument for <code>-Dquarkus.native.additional-build-args</code> includes the <code>,</code> symbol,
it needs to be escaped to be processed correcly, e.g. <code>\\,</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inspecting-native-executables"><a class="anchor" href="#inspecting-native-executables"></a>Inspecting Native Executables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given a native executable, various Linux tools can be used to inspect it.
To allow supporting a variety of environments,
inspections will be done from within a Linux container.
Let&#8217;s create a Linux container image with all the tools required for this guide:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dockerfile" data-lang="dockerfile">FROM fedora:35

RUN dnf install -y \
binutils \
gdb \
git \
perf \
perl-open

ENV FG_HOME /opt/FlameGraph

RUN git clone https://github.com/brendangregg/FlameGraph $FG_HOME

WORKDIR /data

ENTRYPOINT /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using docker in the non-Linux environment, you can create an image using this Dockerfile via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker build -t fedora-tools:v1 .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, go to the root of the project and run the Docker container we have just created as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -t -i --rm -v ${PWD}:/data -p 8080:8080 fedora-tools:v1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ldd</code> shows the shared library dependencies of an executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ldd ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>strings</code> can be used to look for text messages inside the binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">strings ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep Hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>strings</code> you can also get Mandrel information given the binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">strings ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep core.VM</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, using <code>readelf</code> we can inspect different sections of the binary.
For example, we can see how the heap and text sections take most of binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">readelf -SW ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="native-reports"><a class="anchor" href="#native-reports"></a>Native Reports</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Optionally, the native build process can generate reports that show what goes into the binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.enable-reports</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reports will be created under <code>target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/reports/</code>.
These reports are some of the most useful resources when encountering issues with missing methods/classes, or encountering forbidden methods by Mandrel.</p>
</div>
<div class="sect2">
<h3 id="call-tree-reports"><a class="anchor" href="#call-tree-reports"></a>Call Tree Reports</h3>
<div class="paragraph">
<p><code>call_tree</code> text file report is one of the default reports generated when the <code>-Dquarkus.native.enable-reports</code> option is passed in.
This is useful for getting an approximation on why a method/class is included in the binary.
However, the text format makes it very difficult to read and can take up a lot of space.</p>
</div>
<div class="paragraph">
<p>Since Mandrel 21.3.0.0, the call tree is also reported as a group of CSV files.
The CSV output can be enabled by adding <code>-H:PrintAnalysisCallTreeType=CSV</code> to the additional native arguments. E.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.enable-reports \
    -Dquarkus.native.additional-build-args=-H:PrintAnalysisCallTreeType=CSV</code></pre>
</div>
</div>
<div class="paragraph">
<p>These can in turn be imported into a graph database, such as Neo4j,
to inspect them more easily and run queries against the call tree.
Let’s see this in action.</p>
</div>
<div class="paragraph">
<p>First, start a Neo4j instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export NEO_PASS=...
docker run \
    --detach \
    --rm \
    --name testneo4j \
    -p7474:7474 -p7687:7687 \
    --env NEO4J_AUTH=neo4j/${NEO_PASS} \
    neo4j:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the container is running,
you can access the <a href="http://localhost:7474">Neo4j browser</a>.
Use <code>neo4j</code> as the username and the value of <code>NEO_PASS</code> as the password to log in.</p>
</div>
<div class="paragraph">
<p>To import the CSV files,
we need the following cypher script which will import the data within the CSV files and create graph database nodes and edges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">CREATE CONSTRAINT unique_vm_id ON (v:VM) ASSERT v.vmId IS UNIQUE;
CREATE CONSTRAINT unique_method_id ON (m:Method) ASSERT m.methodId IS UNIQUE;

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_vm.csv' AS row
MERGE (v:VM {vmId: row.Id, name: row.Name})
RETURN count(v);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_methods.csv' AS row
MERGE (m:Method {methodId: row.Id, name: row.Name, type: row.Type, parameters: row.Parameters, return: row.Return, display: row.Display})
RETURN count(m);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_virtual_methods.csv' AS row
MERGE (m:Method {methodId: row.Id, name: row.Name, type: row.Type, parameters: row.Parameters, return: row.Return, display: row.Display})
RETURN count(m);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_entry_points.csv' AS row
MATCH (m:Method {methodId: row.Id})
MATCH (v:VM {vmId: '0'})
MERGE (v)-[:ENTRY]-&gt;(m)
RETURN count(*);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_direct_edges.csv' AS row
MATCH (m1:Method {methodId: row.StartId})
MATCH (m2:Method {methodId: row.EndId})
MERGE (m1)-[:DIRECT {bci: row.BytecodeIndexes}]-&gt;(m2)
RETURN count(*);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_override_by_edges.csv' AS row
MATCH (m1:Method {methodId: row.StartId})
MATCH (m2:Method {methodId: row.EndId})
MERGE (m1)-[:OVERRIDEN_BY]-&gt;(m2)
RETURN count(*);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_virtual_edges.csv' AS row
MATCH (m1:Method {methodId: row.StartId})
MATCH (m2:Method {methodId: row.EndId})
MERGE (m1)-[:VIRTUAL {bci: row.BytecodeIndexes}]-&gt;(m2)
RETURN count(*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy and paste the contents of the script into a file called <code>import.cypher</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Mandrel 22.0.0 contains a bug where the symbolic links used by the import cypher file are not correctly set when generating reports within a container
(for more details see <a href="https://github.com/oracle/graal/issues/4355">here</a>).
This can be worked around by copying the following script into a file and executing it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">set -e

project="debugging-native"

pushd target/*-native-image-source-jar/reports

rm -f call_tree_vm.csv
ln -s call_tree_vm_${project}-* call_tree_vm.csv

rm -f call_tree_direct_edges.csv
ln -s call_tree_direct_edges_${project}-* call_tree_direct_edges.csv

rm -f call_tree_entry_points.csv
ln -s call_tree_entry_points_${project}-* call_tree_entry_points.csv

rm -f call_tree_methods.csv
ln -s call_tree_methods_${project}-* call_tree_methods.csv

rm -f call_tree_virtual_edges.csv
ln -s call_tree_virtual_edges_${project}-* call_tree_virtual_edges.csv

rm -f call_tree_virtual_methods.csv
ln -s call_tree_virtual_methods_${project}-* call_tree_virtual_methods.csv

rm -f call_tree_override_by_edges.csv
ln -s call_tree_override_by_edges_${project}-* call_tree_override_by_edges.csv

popd</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, copy the import cypher script and CSV files into Neo4j&#8217;s import folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker cp \
    target/*-native-image-source-jar/reports \
    testneo4j:/var/lib/neo4j/import

docker cp import.cypher testneo4j:/var/lib/neo4j</code></pre>
</div>
</div>
<div class="paragraph">
<p>After copying all the files, invoke the import script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker exec testneo4j bin/cypher-shell -u neo4j -p ${NEO_PASS} -f import.cypher</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the import completes (shouldn&#8217;t take more than a couple of minutes), go to the <a href="http://localhost:7474">Neo4j browser</a>,
and you&#8217;ll be able to observe a small summary of the data in the graph:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/native-reference-neo4j-db-info.png" alt="Neo4j database information after import">
</div>
</div>
<div class="paragraph">
<p>The data above shows that there are ~60000 methods, and just over ~200000 edges between them.
The Quarkus application demonstrated here is very basic, so there’s not a lot we can explore, but here are some example queries you can run to explore the graph in more detail.
Typically, you’d start by looking for a given method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">match (m:Method) where m.name = "hello" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>From there, you can narrow down to a given method on a specific type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">match (m:Method) where m.name = "hello" and m.type =~ ".*GreetingResource" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you’ve located the node for the specific method you’re after, a typical question you’d want to get an answer for is:
why does this method get included in the call tree?
To do that, start from the method and look for incoming connections at a given depth,
starting from the end method.
For example, methods that directly call a method can be located via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">match (m:Method) &lt;- [*1..1] - (o) where m.name = "hello" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can look for direct calls at depth of 2,
so you’d search for methods that call methods that call into the target method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">match (m:Method) &lt;- [*1..2] - (o) where m.name = "hello" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can continue going up layers,
but unfortunately if you reach a depth with too many nodes,
the Neo4j browser will be unable to visualize them all.
When that happens, you can alternatively run the queries directly against the cypher shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker exec testneo4j bin/cypher-shell -u neo4j -p ${NEO_PASS} \
  "match (m:Method) &lt;- [*1..10] - (o) where m.name = 'hello' return *"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For further information, check out this
<a href="https://quarkus.io/blog/quarkus-native-neo4j-call-tree">blog post</a>
that explores the Quarkus Hibernate ORM quickstart using the techniques explained above.</p>
</div>
</div>
<div class="sect2">
<h3 id="used-packagesclassesmethods-reports"><a class="anchor" href="#used-packagesclassesmethods-reports"></a>Used Packages/Classes/Methods Reports</h3>
<div class="paragraph">
<p><code>used_packages</code>, <code>used_classes</code> and <code>used_methods</code> text file reports come in handy when comparing different versions of the application,
e.g. why does the image take longer to build? Or why is the image bigger now?</p>
</div>
</div>
<div class="sect2">
<h3 id="further-reports"><a class="anchor" href="#further-reports"></a>Further Reports</h3>
<div class="paragraph">
<p>Mandrel can produce further reports beyond the ones that are enabled with the <code>-Dquarkus.native.enable-reports</code> option.
These are called expert options and you can learn more about them by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run quay.io/quarkus/ubi-quarkus-mandrel:22.0-java11 --expert-options-all</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use these expert options, add them comma separated to the <code>-Dquarkus.native.additional-build-args</code> parameter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build-time-vs-run-time-initialization"><a class="anchor" href="#build-time-vs-run-time-initialization"></a>Build-time vs Run-time Initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus instructs Mandrel to initialize as much as possible at build time,
so that runtime startup can be as fast as possible.
This is important in containerized environments where the startup speed has a big impact on how quickly an application is ready to do work.
Build time initialization also minimizes the risk of runtime failures due to unsupported features becoming reachable through runtime initialization,
thus making Quarkus more reliable.</p>
</div>
<div class="paragraph">
<p>The most common examples of build-time initialized code are static variables and blocks.
Although Mandrel executes those at run-time by default,
Quarkus instructs Mandrel to run them at build-time for the reasons given.</p>
</div>
<div class="paragraph">
<p>This means that any static variables initialized inline, or initialized in a static block,
will keep the same value even if the application is restarted.
This is a different behaviour compared to what would happen if executed as Java.</p>
</div>
<div class="paragraph">
<p>To see this in action with a very basic example,
add a new <code>TimestampResource</code> to the application that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.acme;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@Path("/timestamp")
public class TimestampResource {

    static long firstAccess = System.currentTimeMillis();

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String timestamp() {
        return "First access " + firstAccess;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rebuild the binary using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the application in one terminal
(make sure you stop any other native executable container runs before executing this):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send a <code>GET</code> request multiple times from another terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -w '\n' http://localhost:8080/timestamp # run this multiple times</code></pre>
</div>
</div>
<div class="paragraph">
<p>to see how the current time has been baked into the binary.
This time was calculated when the binary was being built,
hence application restarts have no effect.</p>
</div>
<div class="paragraph">
<p>In some situations, built time initializations can lead to errors when building native executables.
One example is when a value gets computed at build time which is forbidden to reside in the heap of the JVM that gets baked into the binary.
To see this in action, add this REST resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.acme;

import org.jboss.resteasy.annotations.jaxrs.PathParam;

import javax.crypto.Cipher;
import javax.crypto.NoSuchPaddingException;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import java.nio.charset.StandardCharsets;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.NoSuchAlgorithmException;

@Path("/encrypt-decrypt")
public class EncryptDecryptResource {

    static final KeyPairGenerator KEY_PAIR_GEN;
    static final Cipher CIPHER;

    static {
        try {
            KEY_PAIR_GEN = KeyPairGenerator.getInstance("RSA");
            KEY_PAIR_GEN.initialize(1024);

            CIPHER = Cipher.getInstance("RSA");
        } catch (NoSuchAlgorithmException | NoSuchPaddingException e) {
            throw new RuntimeException(e);
        }
    }

    @GET
    @Path("/{message}")
    public String encryptDecrypt(@PathParam String message) throws Exception {
        KeyPair keyPair = KEY_PAIR_GEN.generateKeyPair();

        byte[] text = message.getBytes(StandardCharsets.UTF_8);

        // Encrypt with private key
        CIPHER.init(Cipher.ENCRYPT_MODE, keyPair.getPrivate());
        byte[] encrypted = CIPHER.doFinal(text);

        // Decrypt with public key
        CIPHER.init(Cipher.DECRYPT_MODE, keyPair.getPublic());
        byte[] unencrypted = CIPHER.doFinal(encrypted);

        return new String(unencrypted, StandardCharsets.UTF_8);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When trying to rebuild the application, you’ll encounter an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative
...
Error: Unsupported features in 2 methods
Detailed message:
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  To see how this object got instantiated use --trace-object-instantiation=java.security.SecureRandom. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field java.security.KeyPairGenerator$Delegate.initRandom of
		constant java.security.KeyPairGenerator$Delegate@58b0fe1b reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  To see how this object got instantiated use --trace-object-instantiation=java.security.SecureRandom. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field sun.security.rsa.RSAKeyPairGenerator.random of
		constant sun.security.rsa.RSAKeyPairGenerator$Legacy@3248a092 reached by
	reading field java.security.KeyPairGenerator$Delegate.spi of
		constant java.security.KeyPairGenerator$Delegate@58b0fe1b reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, what the message above is telling us is that our application caches a value that is supposed to be random as a constant.
This is not desirable because something that&#8217;s supposed to be random is no longer so,
because the seed is baked in the image.
The message above makes it quite clear what is causing this,
but in other situations the cause might be more obfuscated.
As a next step, we&#8217;ll add some extra flags to the native executable generation to get more information.</p>
</div>
<div class="paragraph">
<p>As suggested by the message, let&#8217;s start by adding an option to track object instantiation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.additional-build-args="--trace-object-instantiation=java.security.SecureRandom"
...
Error: Unsupported features in 2 methods
Detailed message:
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  Object has been initialized by the com.sun.jndi.dns.DnsClient class initializer with a trace:
 	at java.security.SecureRandom.&lt;init&gt;(SecureRandom.java:218)
	at sun.security.jca.JCAUtil$CachedSecureRandomHolder.&lt;clinit&gt;(JCAUtil.java:59)
	at sun.security.jca.JCAUtil.getSecureRandom(JCAUtil.java:69)
	at com.sun.jndi.dns.DnsClient.&lt;clinit&gt;(DnsClient.java:82)
. Try avoiding to initialize the class that caused initialization of the object. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field java.security.KeyPairGenerator$Delegate.initRandom of
		constant java.security.KeyPairGenerator$Delegate@4a5058f9 reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  Object has been initialized by the com.sun.jndi.dns.DnsClient class initializer with a trace:
 	at java.security.SecureRandom.&lt;init&gt;(SecureRandom.java:218)
	at sun.security.jca.JCAUtil$CachedSecureRandomHolder.&lt;clinit&gt;(JCAUtil.java:59)
	at sun.security.jca.JCAUtil.getSecureRandom(JCAUtil.java:69)
	at com.sun.jndi.dns.DnsClient.&lt;clinit&gt;(DnsClient.java:82)
. Try avoiding to initialize the class that caused initialization of the object. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field sun.security.rsa.RSAKeyPairGenerator.random of
		constant sun.security.rsa.RSAKeyPairGenerator$Legacy@71880cf1 reached by
	reading field java.security.KeyPairGenerator$Delegate.spi of
		constant java.security.KeyPairGenerator$Delegate@4a5058f9 reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error messages point to the code in the example,
but it can be suprising that a reference to <code>DnsClient</code> appears.
Why is that?
The key is in what happens inside <code>KeyPairGenerator.initialize()</code> method call.
It uses <code>JCAUtil.getSecureRandom()</code> which is why this is problematic,
but sometimes the tracing options can show some stack traces that do not represent what happens in reality.
The best option is to dig through the source code and use tracing output for guidance but not as full truth.</p>
</div>
<div class="paragraph">
<p>Moving the <code>KEY_PAIR_GEN.initialize(1024);</code> call to the run-time executed method <code>encryptDecrypt</code> is enough to solve this particular issue.</p>
</div>
<div class="paragraph">
<p>Additional information on which classes are initialized and why can be obtained by passing in the <code>-H:+PrintClassInitialization</code> flag via <code>-Dquarkus.native.additional-build-args</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="profile-runtime-behaviour"><a class="anchor" href="#profile-runtime-behaviour"></a>Profile Runtime Behaviour</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="single-thread"><a class="anchor" href="#single-thread"></a>Single Thread</h3>
<div class="paragraph">
<p>In this exercise, we profile the runtime behaviour of some Quarkus application that was compiled to a native executable to determine where the bottleneck is.
Assume that you’re in a scenario where profiling the pure Java version is not possible, maybe because the issue only occurs with the native version of the application.</p>
</div>
<div class="paragraph">
<p>Add a REST resource with the following code
(example courtesy of <a href="https://github.com/apangin/java-profiling-presentation/blob/master/src/demo1/StringBuilderTest.java">Andrei Pangin&#8217;s Java Profiling presentation</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.acme;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@Path("/string-builder")
public class StringBuilderResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String appendDelete() {
        StringBuilder sb = new StringBuilder();
        sb.append(new char[1_000_000]);

        do
        {
            sb.append(12345);
            sb.delete(0, 5);
        } while (Thread.currentThread().isAlive());

        return "Never happens";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recompile the application, rebuild the binary and run it. Attempting a simple curl will never complete, as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ./mvnw package -DskipTests -Pnative
...
$ docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT
...
$ curl http://localhost:8080/string-builder # this will never complete</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the question we’re trying to answer here is:
what would be the bottleneck of such code?
Is it appending the characters? Is it deleting it? Is it checking whether the thread is alive?</p>
</div>
<div class="paragraph">
<p>Since we&#8217;re dealing with a linux native executable,
we can use tools like <code>perf</code> directly.
To use <code>perf</code>,
go to the root of the project and start the tools container created earlier as a privileged user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run --privileged -t -i --rm -v ${PWD}:/data -p 8080:8080 fedora-tools:v1</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that in order to use <code>perf</code> to profile the native executables in the guide,
the container needs to run as privileged, or with <code>--cap-add sys_admin</code>.
Please note that privileged containers are <strong>NOT</strong> recommended in production, so use this flag with caution!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the container is running, you need to ensure that the kernel is ready for the profiling exercises:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">echo -1 | sudo tee /proc/sys/kernel/perf_event_paranoid
echo 0 | sudo tee /proc/sys/kernel/kptr_restrict</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The kernel modifications above also apply to Linux virtual machines.
If running on a bare metal Linux machine,
tweaking only <code>perf_event_paranoid</code> is enough.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, from inside the tools container we execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf record -F 1009 -g -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>While <code>perf record</code> is running, open another window and access the endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/string-builder # this will never complete</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a few seconds, halt the <code>perf record</code> process.
This will generate a <code>perf.data</code> file.
We could use <code>perf report</code> to inspect the perf data,
but you can often get a better picture showing that data as a flame graph.
To generate flame graphs, we will use
<a href="https://github.com/brendangregg/FlameGraph">FlameGraph GitHub repository</a>,
which has already been installed inside the tools container.</p>
</div>
<div class="paragraph">
<p>Next, generate a flame graph using the data captured via <code>perf record</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ perf script -i perf.data | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
$ ${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="paragraph">
<p>The flame graph is an svg file that a web browser, such as Firefox, can easily display.
After the above two commands complete one can open <code>flamegraph.svg</code> in their browser:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/native-reference-perf-flamegraph-no-symbols.svg" alt="Perf flamegraph without symbols">
</div>
</div>
<div class="paragraph">
<p>We see a big majority of time spent in what is supposed to be our main,
but we see no trace of the <code>StringBuilderResource</code> class,
nor the <code>StringBuilder</code> class we&#8217;re calling.
We should look at the symbol table of the binary:
can we find symbols for our class and <code>StringBuilder</code>?
We need those in order to get meaningful data.
From within the tools container, query the symbol table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">objdump -t ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep StringBuilder
[no output]</code></pre>
</div>
</div>
<div class="paragraph">
<p>No output appears when querying the symbol table.
This is why we don&#8217;t see any call graphs in the flame graphs.
This is a deliberate decision that native-image makes.
By default, it removes symbols from the binary.</p>
</div>
<div class="paragraph">
<p>To regain the symbols, we need to rebuild the binary instructing GraalVM not to delete the symbols.
On top of that, enable DWARF debug info so that the stack traces can be populated with that information.
From outside the tools container, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.debug.enabled \
    -Dquarkus.native.additional-build-args=-H:-DeleteLocalSymbols</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, re-enter the tools container if you exited,
and inspect the native executable with <code>objdump</code>,
and see how the symbols are now present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ objdump -t ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep StringBuilder
000000000050a940 l     F .text	0000000000000091              .hidden ReflectionAccessorHolder_StringBuilderResource_appendDelete_9e06d4817d0208a0cce97ebcc0952534cac45a19_e22addf7d3eaa3ad14013ce01941dc25beba7621
000000000050a9e0 l     F .text	00000000000000bb              .hidden ReflectionAccessorHolder_StringBuilderResource_constructor_0f8140ea801718b80c05b979a515d8a67b8f3208_12baae06bcd6a1ef9432189004ae4e4e176dd5a4
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a long list of symbols that match that pattern.</p>
</div>
<div class="paragraph">
<p>Then, run the executable through perf,
<strong>indicating that the call graph is dwarf</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf record -F 1009 --call-graph dwarf -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the curl command once again, stop the binary, generate the flamegraphs and open it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf script -i perf.data | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="paragraph">
<p>The flamegraph now shows where the bottleneck is.
It&#8217;s when <code>StringBuilder.delete()</code> is called which calls <code>System.arraycopy()</code>.
The issue is that 1 million characters need to be shifted in very small increments:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/native-reference-perf-flamegraph-symbols.svg" alt="Perf flamegraph with symbols">
</div>
</div>
</div>
<div class="sect2">
<h3 id="multi-thread"><a class="anchor" href="#multi-thread"></a>Multi-Thread</h3>
<div class="paragraph">
<p>Multi-threaded programs might require special attention when trying to understand their runtime behaviour.
To demonstrate this, add this <code>MulticastResource</code> code to your project
(example courtesy of <a href="https://github.com/apangin/java-profiling-presentation/blob/master/src/demo6/DatagramTest.java">Andrei Pangin&#8217;s Java Profiling presentation</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.acme;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.DatagramChannel;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;

@Path("/multicast")
public class MulticastResource
{
    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String send() throws Exception {
        sendMulticasts();
        return "Multicast packets sent";
    }

    static void sendMulticasts() throws Exception {
        DatagramChannel ch = DatagramChannel.open();
        ch.bind(new InetSocketAddress(5555));
        ch.configureBlocking(false);

        ExecutorService pool =
            Executors.newCachedThreadPool(new ShortNameThreadFactory());
        for (int i = 0; i &lt; 10; i++) {
            pool.submit(() -&gt; {
                final ByteBuffer buf = ByteBuffer.allocateDirect(1000);
                final InetSocketAddress remoteAddr =
                    new InetSocketAddress("127.0.0.1", 5556);

                while (true) {
                    buf.clear();
                    ch.send(buf, remoteAddr);
                }
            });
        }

        System.out.println("Warming up...");
        Thread.sleep(3000);

        System.out.println("Benchmarking...");
        Thread.sleep(5000);
    }

    private static final class ShortNameThreadFactory implements ThreadFactory {

        private final AtomicInteger threadNumber = new AtomicInteger(1);
        private final String namePrefix = "thread-";

        public Thread newThread(Runnable r) {
            return new Thread(r, namePrefix + threadNumber.getAndIncrement());
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Build the native executable with debug info:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.debug.enabled \
    -Dquarkus.native.additional-build-args=-H:-DeleteLocalSymbols</code></pre>
</div>
</div>
<div class="paragraph">
<p>From inside the tools container (as privileged user) run the native executable through <code>perf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf record -F 1009 --call-graph dwarf -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoke the endpoint to send the multicast packets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -w '\n' http://localhost:8080/multicast</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make and open a flamegraph:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf script -i perf.data | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/native-reference-multi-flamegraph-separate-threads.svg" alt="Muti-thread perf flamegraph with separate threads">
</div>
</div>
<div class="paragraph">
<p>The flamegraph produced looks odd. Each thread is treated independently even though they all do the same work.
This makes it difficult to have a clear picture of the bottlenecks in the program.</p>
</div>
<div class="paragraph">
<p>This is happening because from a <code>perf</code> perspective, each thread is a different command.
We can see that if we inspect <code>perf report</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf report --stdio
# Children      Self  Command          Shared Object       Symbol
# ........  ........  ...............  ......................................  ......................................................................................
...
     6.95%     0.03%  thread-2         debugging-native-1.0.0-SNAPSHOT-runner  [.] MulticastResource_lambda$sendMulticasts$0_cb1f7b5dcaed7dd4e3f90d18bad517d67eae4d88
...
     4.60%     0.02%  thread-10        debugging-native-1.0.0-SNAPSHOT-runner  [.] MulticastResource_lambda$sendMulticasts$0_cb1f7b5dcaed7dd4e3f90d18bad517d67eae4d88
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be worked around by applying some modifications to the perf output,
in order to make all threads have the same name. E.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf script | sed -E "s/thread-[0-9]*/thread/" | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/native-reference-multi-flamegraph-joined-threads.svg" alt="Muti-thread perf flamegraph with joined threads">
</div>
</div>
<div class="paragraph">
<p>When you open the flamegraph, you will see all threads' work collapsed into a single area.
Then, you can clearly see that there&#8217;s some locking that could affect performance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging-native-crashes"><a class="anchor" href="#debugging-native-crashes"></a>Debugging Native Crashes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the drawbacks of using native executables is that they cannot be debugged using the standard Java debuggers,
instead we need to debug them using <code>gdb</code>, the GNU Project debugger.
To demonstrate how to do this,
we are going to generate a native Quarkus application that crashes due to a Segmentation Fault when accessing <a href="http://localhost:8080/crash" class="bare">http://localhost:8080/crash</a>.
To achieve this, add the following REST resource to the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.acme;

import sun.misc.Unsafe;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import java.lang.reflect.Field;

@Path("/crash")
public class CrashResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        Field theUnsafe = null;
        try {
            theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
            theUnsafe.setAccessible(true);
            Unsafe unsafe = (Unsafe) theUnsafe.get(null);
            unsafe.copyMemory(0, 128, 256);
        } catch (NoSuchFieldException | IllegalAccessException e) {
            e.printStackTrace();
        }
        return "Never happens";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code will try to copy 256 bytes from address <code>0x0</code> to <code>0x80</code> resulting in a Segmentation Fault.
To verify this compile and run the example application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ./mvnw package -DskipTests -Pnative
...
$ docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT
...
$ curl http://localhost:8080/crash</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT
...
Segfault detected, aborting process. Use runtime option -R:-InstallSegfaultHandler if you don't want to use SubstrateSegfaultHandler.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The omitted output above contains clues to what caused the issue,
but in this exercise we are going to assume that no information was provided.
Let’s try to debug the segmentation fault using <code>gdb</code>.
To do that, go to the root of the project and enter the tools container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -t -i --rm -v ${PWD}:/data -p 8080:8080 fedora-tools:v1 /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then start the application in <code>gdb</code> and execute <code>run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gdb ./target/debugging-native-1.0.0-SNAPSHOT-runner
...
Reading symbols from ./target/debugging-native-1.0.0-SNAPSHOT-runner...
(No debugging symbols found in ./target/debugging-ntaive-1.0.0-SNAPSHOT-runner)
(gdb) run
Starting program: /data/target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, try to access <a href="http://localhost:8080/crash" class="bare">http://localhost:8080/crash</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/crash</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in the following message in <code>gdb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Thread 4 "ecutor-thread-0" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fe103dff640 (LWP 190)]
0x0000000000461f6e in ?? ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we try to get more info about the backtrace that led to this crash we will see that there is not enough information available.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) bt
#0  0x0000000000418b5e in ?? ()
#1  0x00007ffff6f2d328 in ?? ()
#2  0x0000000000418a04 in ?? ()
#3  0x00007ffff44062a0 in ?? ()
#4  0x00000000010c3dd3 in ?? ()
#5  0x0000000000000100 in ?? ()
#6  0x0000000000000000 in ?? ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is because we didn’t compile the Quarkus application with <code>-Dquarkus.native.debug.enabled</code>,
so <code>gdb</code> cannot find debugging symbols for our native executable,
as indicated by the "<em>No debugging symbols found in ./target/debugging-native-1.0.0-SNAPSHOT-runner</em>" message in the beginning of <code>gdb</code>.</p>
</div>
<div class="paragraph">
<p>Recompiling the Quarkus application with <code>-Dquarkus.native.debug.enabled</code> and rerunning it through <code>gdb</code> we are now able to get a backtrace making clear what caused the crash.
On top of that, add <code>-H:-OmitInlinedMethodDebugLineInfo</code> option to avoid inlined methods being omitted from the backtrace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.debug.enabled \
    -Dquarkus.native.additional-build-args=-H:-OmitInlinedMethodDebugLineInfo
...
$ gdb ./target/debugging-native-1.0.0-SNAPSHOT-runner
Reading symbols from ./target/debugging-native-1.0.0-SNAPSHOT-runner...
(gdb) run
Starting program: /data/target/debugging-native-1.0.0-SNAPSHOT-runner
...
$ curl http://localhost:8080/crash</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in the following message in <code>gdb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Thread 4 "ecutor-thread-0" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fffeffff640 (LWP 362984)]
com.oracle.svm.core.UnmanagedMemoryUtil::copyLongsBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) ()
	at com/oracle/svm/core/UnmanagedMemoryUtil.java:169
169    com/oracle/svm/core/UnmanagedMemoryUtil.java: No such file or directory.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We already see that <code>gdb</code> is able to tell us which method caused the crash and where it’s located in the source code.
We can also get a backtrace of the call graph that led us to this state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) bt
#0  com.oracle.svm.core.UnmanagedMemoryUtil::copyLongsBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:169
#1  0x0000000000461e14 in com.oracle.svm.core.UnmanagedMemoryUtil::copyBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:110
#2  0x0000000000461dc8 in com.oracle.svm.core.UnmanagedMemoryUtil::copy(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:67
#3  0x000000000045d3c0 in com.oracle.svm.core.JavaMemoryUtil::unsafeCopyMemory(java.lang.Object *, long, java.lang.Object *, long, long) () at com/oracle/svm/core/JavaMemoryUtil.java:276
#4  0x00000000013277de in jdk.internal.misc.Unsafe::copyMemory0 () at com/oracle/svm/core/jdk/SunMiscSubstitutions.java:125
#5  jdk.internal.misc.Unsafe::copyMemory(java.lang.Object *, long, java.lang.Object *, long, long) () at jdk/internal/misc/Unsafe.java:788
#6  0x00000000013b1a3f in jdk.internal.misc.Unsafe::copyMemory () at jdk/internal/misc/Unsafe.java:799
#7  sun.misc.Unsafe::copyMemory () at sun/misc/Unsafe.java:585
#8  org.acme.CrashResource::hello(void) () at org/acme/CrashResource.java:22</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, we can get a backtrace of the call graph of other threads.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, we can list the available threads with:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) info threads
  Id   Target Id                                             Frame
  1    Thread 0x7fcc62a07d00 (LWP 322) "debugging-nativ" 0x00007fcc62b8b77a in __futex_abstimed_wait_common () from /lib64/libc.so.6
  2    Thread 0x7fcc60eff640 (LWP 326) "gnal Dispatcher" 0x00007fcc62b8b77a in __futex_abstimed_wait_common () from /lib64/libc.so.6
* 4    Thread 0x7fcc5b7fe640 (LWP 328) "ecutor-thread-0" com.oracle.svm.core.UnmanagedMemoryUtil::copyLongsBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:169
  5    Thread 0x7fcc5abff640 (LWP 329) "-thread-checker" 0x00007fcc62b8b77a in __futex_abstimed_wait_common () from /lib64/libc.so.6
  6    Thread 0x7fcc59dff640 (LWP 330) "ntloop-thread-0" 0x00007fcc62c12c9e in epoll_wait () from /lib64/libc.so.6
...</code></pre>
</div>
</div>
</li>
<li>
<p>select the thread we want to inspect, e.g. thread 1:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) thread 1
[Switching to thread 1 (Thread 0x7ffff7a58d00 (LWP 1028851))]
#0  __futex_abstimed_wait_common64 (private=0, cancel=true, abstime=0x0, op=393, expected=0, futex_word=0x2cd7adc) at futex-internal.c:57
57	    return INTERNAL_SYSCALL_CANCEL (futex_time64, futex_word, op, expected,</code></pre>
</div>
</div>
</li>
<li>
<p>and, finally, print the stack trace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) bt
#0  __futex_abstimed_wait_common64 (private=0, cancel=true, abstime=0x0, op=393, expected=0, futex_word=0x2cd7adc) at futex-internal.c:57
#1  __futex_abstimed_wait_common (futex_word=futex_word@entry=0x2cd7adc, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, private=private@entry=0,
    cancel=cancel@entry=true) at futex-internal.c:87
#2  0x00007ffff7bdd79f in __GI___futex_abstimed_wait_cancelable64 (futex_word=futex_word@entry=0x2cd7adc, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0,
    private=private@entry=0) at futex-internal.c:139
#3  0x00007ffff7bdfeb0 in __pthread_cond_wait_common (abstime=0x0, clockid=0, mutex=0x2ca07b0, cond=0x2cd7ab0) at pthread_cond_wait.c:504
#4  ___pthread_cond_wait (cond=0x2cd7ab0, mutex=0x2ca07b0) at pthread_cond_wait.c:619
#5  0x00000000004e2014 in com.oracle.svm.core.posix.headers.Pthread::pthread_cond_wait () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:252
#6  com.oracle.svm.core.posix.thread.PosixParkEvent::condWait(void) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:252
#7  0x0000000000547070 in com.oracle.svm.core.thread.JavaThreads::park(void) () at com/oracle/svm/core/thread/JavaThreads.java:764
#8  0x0000000000fc5f44 in jdk.internal.misc.Unsafe::park(boolean, long) () at com/oracle/svm/core/thread/Target_jdk_internal_misc_Unsafe_JavaThreads.java:49
#9  0x0000000000eac1ad in java.util.concurrent.locks.LockSupport::park(java.lang.Object *) () at java/util/concurrent/locks/LockSupport.java:194
#10 0x0000000000ea5d68 in java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject::awaitUninterruptibly(void) ()
    at java/util/concurrent/locks/AbstractQueuedSynchronizer.java:2018
#11 0x00000000008b6b30 in io.quarkus.runtime.ApplicationLifecycleManager::run(io.quarkus.runtime.Application *, java.lang.Class *, java.util.function.BiConsumer *, java.lang.String[] *) ()
    at io/quarkus/runtime/ApplicationLifecycleManager.java:144
#12 0x00000000008bc055 in io.quarkus.runtime.Quarkus::run(java.lang.Class *, java.util.function.BiConsumer *, java.lang.String[] *) () at io/quarkus/runtime/Quarkus.java:67
#13 0x000000000045c88b in io.quarkus.runtime.Quarkus::run () at io/quarkus/runtime/Quarkus.java:41
#14 io.quarkus.runtime.Quarkus::run () at io/quarkus/runtime/Quarkus.java:120
#15 0x000000000045c88b in io.quarkus.runner.GeneratedMain::main ()
#16 com.oracle.svm.core.JavaMainWrapper::runCore () at com/oracle/svm/core/JavaMainWrapper.java:150
#17 com.oracle.svm.core.JavaMainWrapper::run(int, org.graalvm.nativeimage.c.type.CCharPointerPointer *) () at com/oracle/svm/core/JavaMainWrapper.java:186
#18 0x000000000048084d in com.oracle.svm.core.code.IsolateEnterStub::JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b(int, org.graalvm.nativeimage.c.type.CCharPointerPointer *)
    () at com/oracle/svm/core/JavaMainWrapper.java:280</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Alternatively, we can list the backtraces of all threads with a single command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) thread apply all backtrace

Thread 22 (Thread 0x7fffc8dff640 (LWP 1028872) "tloop-thread-15"):
#0  0x00007ffff7c64c2e in epoll_wait (epfd=8, events=0x2ca3880, maxevents=1024, timeout=-1) at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
#1  0x000000000166e01c in Java_sun_nio_ch_EPoll_wait ()
#2  0x00000000011bfece in sun.nio.ch.EPoll::wait(int, long, int, int) () at com/oracle/svm/core/stack/JavaFrameAnchors.java:42
#3  0x00000000011c08d2 in sun.nio.ch.EPollSelectorImpl::doSelect(java.util.function.Consumer *, long) () at sun/nio/ch/EPollSelectorImpl.java:120
#4  0x00000000011d8977 in sun.nio.ch.SelectorImpl::lockAndDoSelect(java.util.function.Consumer *, long) () at sun/nio/ch/SelectorImpl.java:124
#5  0x0000000000705720 in sun.nio.ch.SelectorImpl::select () at sun/nio/ch/SelectorImpl.java:141
#6  io.netty.channel.nio.SelectedSelectionKeySetSelector::select(void) () at io/netty/channel/nio/SelectedSelectionKeySetSelector.java:68
#7  0x0000000000703c2e in io.netty.channel.nio.NioEventLoop::select(long) () at io/netty/channel/nio/NioEventLoop.java:813
#8  0x0000000000701a5f in io.netty.channel.nio.NioEventLoop::run(void) () at io/netty/channel/nio/NioEventLoop.java:460
#9  0x00000000008496df in io.netty.util.concurrent.SingleThreadEventExecutor$4::run(void) () at io/netty/util/concurrent/SingleThreadEventExecutor.java:986
#10 0x0000000000860762 in io.netty.util.internal.ThreadExecutorMap$2::run(void) () at io/netty/util/internal/ThreadExecutorMap.java:74
#11 0x0000000000840da4 in io.netty.util.concurrent.FastThreadLocalRunnable::run(void) () at io/netty/util/concurrent/FastThreadLocalRunnable.java:30
#12 0x0000000000b7dd04 in java.lang.Thread::run(void) () at java/lang/Thread.java:829
#13 0x0000000000547dcc in com.oracle.svm.core.thread.JavaThreads::threadStartRoutine(org.graalvm.nativeimage.ObjectHandle *) () at com/oracle/svm/core/thread/JavaThreads.java:597
#14 0x00000000004e15b1 in com.oracle.svm.core.posix.thread.PosixJavaThreads::pthreadStartRoutine(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:194
#15 0x0000000000480984 in com.oracle.svm.core.code.IsolateEnterStub::PosixJavaThreads_pthreadStartRoutine_e1f4a8c0039f8337338252cd8734f63a79b5e3df(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:182
#16 0x00007ffff7be0b1a in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:443
#17 0x00007ffff7c65650 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81

Thread 21 (Thread 0x7fffc97fa640 (LWP 1028871) "tloop-thread-14"):
#0  0x00007ffff7c64c2e in epoll_wait (epfd=53, events=0x2cd0970, maxevents=1024, timeout=-1) at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
#1  0x000000000166e01c in Java_sun_nio_ch_EPoll_wait ()
#2  0x00000000011bfece in sun.nio.ch.EPoll::wait(int, long, int, int) () at com/oracle/svm/core/stack/JavaFrameAnchors.java:42
#3  0x00000000011c08d2 in sun.nio.ch.EPollSelectorImpl::doSelect(java.util.function.Consumer *, long) () at sun/nio/ch/EPollSelectorImpl.java:120
#4  0x00000000011d8977 in sun.nio.ch.SelectorImpl::lockAndDoSelect(java.util.function.Consumer *, long) () at sun/nio/ch/SelectorImpl.java:124
#5  0x0000000000705720 in sun.nio.ch.SelectorImpl::select () at sun/nio/ch/SelectorImpl.java:141
#6  io.netty.channel.nio.SelectedSelectionKeySetSelector::select(void) () at io/netty/channel/nio/SelectedSelectionKeySetSelector.java:68
#7  0x0000000000703c2e in io.netty.channel.nio.NioEventLoop::select(long) () at io/netty/channel/nio/NioEventLoop.java:813
#8  0x0000000000701a5f in io.netty.channel.nio.NioEventLoop::run(void) () at io/netty/channel/nio/NioEventLoop.java:460
#9  0x00000000008496df in io.netty.util.concurrent.SingleThreadEventExecutor$4::run(void) () at io/netty/util/concurrent/SingleThreadEventExecutor.java:986
#10 0x0000000000860762 in io.netty.util.internal.ThreadExecutorMap$2::run(void) () at io/netty/util/internal/ThreadExecutorMap.java:74
#11 0x0000000000840da4 in io.netty.util.concurrent.FastThreadLocalRunnable::run(void) () at io/netty/util/concurrent/FastThreadLocalRunnable.java:30
#12 0x0000000000b7dd04 in java.lang.Thread::run(void) () at java/lang/Thread.java:829
#13 0x0000000000547dcc in com.oracle.svm.core.thread.JavaThreads::threadStartRoutine(org.graalvm.nativeimage.ObjectHandle *) () at com/oracle/svm/core/thread/JavaThreads.java:597
#14 0x00000000004e15b1 in com.oracle.svm.core.posix.thread.PosixJavaThreads::pthreadStartRoutine(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:194
#15 0x0000000000480984 in com.oracle.svm.core.code.IsolateEnterStub::PosixJavaThreads_pthreadStartRoutine_e1f4a8c0039f8337338252cd8734f63a79b5e3df(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:182
#16 0x00007ffff7be0b1a in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:443
#17 0x00007ffff7c65650 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81

Thread 20 (Thread 0x7fffc9ffb640 (LWP 1028870) "tloop-thread-13"):
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, however, that despite being able to get a backtrace we can still not list the source code at point with the <code>list</code> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) list
164    in com/oracle/svm/core/UnmanagedMemoryUtil.java</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is because <code>gdb</code> is not aware of the location of the source files.
We are running the executable outside of the target directory.
To fix this we can either rerun <code>gdb</code> from the target directory or,
run <code>directory target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/sources</code> e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">(gdb) directory target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/sources
Source directories searched: /data/target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/sources:$cdir:$cwd
(gdb) list
164        	UnsignedWord offset = size;
165        	while (offset.aboveOrEqual(32)) {
166            	offset = offset.subtract(32);
167            	Pointer src = from.add(offset);
168            	Pointer dst = to.add(offset);
169            	long l24 = src.readLong(24);
170            	long l16 = src.readLong(16);
171            	long l8 = src.readLong(8);
172            	long l0 = src.readLong(0);
173            	dst.writeLong(24, l24);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now examine line <code>169</code> and get a first hint of what might be wrong
(in this case we see that it fails at the first read from src which contains the address <code>0x0000</code>),
or walk up the stack using <code>gdb</code>’s <code>up</code> command to see what part of our code led to this situation.
To learn more about using gdb to debug native executables see
<a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/DebugInfo.md">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="frequently-asked-questions"><a class="anchor" href="#frequently-asked-questions"></a>Frequently Asked Questions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="why-is-the-process-of-generating-a-native-executable-slow"><a class="anchor" href="#why-is-the-process-of-generating-a-native-executable-slow"></a>Why is the process of generating a native executable slow?</h3>
<div class="paragraph">
<p>Native executable generation is a multi-step process.
The analysis and compile steps are the most expensive of all and hence the ones that dominate the time spent generating the native executable.</p>
</div>
<div class="paragraph">
<p>In the analysis phase, a static points-to analysis starts from the main method of the program to find out what is reachable.
As new classes are discovered, some of them will be initialized during this process depending on the configuration.
In the next step, the heap is snapshotted and checks are made to see which types need to be available at runtime.
The initialization and heap snapshotting can cause new types to be discovered, in which case the process is repeated.
The process stops when a fixed point is reached, that is when the reachable program grows no more.</p>
</div>
<div class="paragraph">
<p>The compilation step is pretty straightforward, it simply compiles all the reachable code.</p>
</div>
<div class="paragraph">
<p>The time spent in analysis and compilation phases depends on how big the application is.
The bigger the application, the longer it takes to compile it.
However, there are certain features that can have an exponential effect.
For example, when registering types and methods for reflection access,
the analysis can’t easily see what’s behind those types or methods,
so it has to do more work to complete the analysis step.</p>
</div>
</div>
<div class="sect2">
<h3 id="why-is-runtime-performance-of-a-native-executable-inferior-compared-to-jvm-mode"><a class="anchor" href="#why-is-runtime-performance-of-a-native-executable-inferior-compared-to-jvm-mode"></a>Why is runtime performance of a native executable inferior compared to JVM mode?</h3>
<div class="paragraph">
<p>As with most things in life there are some trade offs involved when choosing native compilation over JVM mode.
So depending on the application the runtime performance of a native application might be slower compared to JVM mode,
though that’s not always the case.</p>
</div>
<div class="paragraph">
<p>JVM execution of an application includes runtime optimization of the code that profits from profile information built up during execution.
That includes the opportunities to inline a lot more of the code,
locate hot code on direct paths (i.e. ensure better instruction cache locality)
and cut out a lot of the code on cold paths (on the JVM a lot of code does not get compiled until something tries to execute it&#8201;&#8212;&#8201;it is replaced with a trap that causes deoptimization and recompilation).
Removal of cold paths provides many more optimization opportunities than are available for ahead of time compilation because it significantly reduces the branch complexity and combinatorial logic of the smaller amount of hot code that is compiled.</p>
</div>
<div class="paragraph">
<p>By contrast, native executable compilation has to cater for all possible execution paths when it compiles code offline since it does not know which are the hot or cold paths and cannot use the trick of planting a trap and recompiling if it is hit. For the same reason it cannot load the dice to ensure that code cache conflicts are minimized by co-locating hot paths adjacent.
Native executable generation is able to remove some code because of the closed world hypothesis but that is often not enough to make up for all the benefits that profiling and runtime deopt &amp; recompile provides to the JVM JIT compiler.</p>
</div>
<div class="paragraph">
<p>Note, however, that there is a price you pay for that potentially higher JVM speed, and that price is in increased resource usage (both CPU and memory) and startup time because:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it takes some time before the JIT kicks in and fully optimizes the code.</p>
</li>
<li>
<p>the JIT compiler consumes resources that could be utilized by the application.</p>
</li>
<li>
<p>the JVM has to retain a lot more metadata and compiler/profiler data to support the better optimizations that it can offer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The reason for 1) is that code needs to be run interpreted for some time and, possibly, to be compiled several times before all potential optimizations are realized to ensure that:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>it’s worth compiling that code path, i.e. it’s being executed enough times, and that</p>
</li>
<li>
<p>we have enough profiling data to perform meaningful optimizations.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An implication of 1) is that for small, short-lived applications a native executable may well be a better bet.
Although the compiled code is not as well optimized it is available straight away.</p>
</div>
<div class="paragraph">
<p>The reason for 2) is that the JVM is essentially running the compiler at runtime in parallel with the application itself.
In the case of native executables the compiler is run ahead of time removing the need to run the compiler in parallel with the application.</p>
</div>
<div class="paragraph">
<p>There are several reasons for 3). The JVM does not have a closed world assumption.
So, it has to be able to recompile code if loading of new classes implies that it needs to revise optimistic assumptions made at compile time.
For example, if an interface has only one implementation it can make a call jump directly to that code.
However, in the case where a second implementation class is loaded the call site needs to be patched to test the type of the receiver instance and jump to the code that belongs to its class.
Supporting optimizations like this one requires keeping track of a lot more details of the class base than a native executable,
including recording the full class and interface hierarchy,
details of which methods override other methods, all method bytecode etc.
In a native executable most of the details of class structure and bytecode can be ignored at run time.</p>
</div>
<div class="paragraph">
<p>The JVM also has to cope with changes to the class base or execution profiles that result in a thread going down a previously cold path.
At that point the JVM has to jump out of the compiled code into the interpreter and recompile the code to cater for a new execution profile that includes the previously cold path.
That requires keeping runtime info that allow a compiled stack frame to be replaced with one or more interpreter frames.
It also requires runtime extensible profile counters to be allocated and updated to track what has or has not been executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="why-are-native-executables-big"><a class="anchor" href="#why-are-native-executables-big"></a>Why are native executables “big”?</h3>
<div class="paragraph">
<p>This can be attributed to a number of different reasons:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Native executables include not only the application code but also, library code, and JDK code.
As a result a more fair comparison would be to compare the native executable’s size with the size of the application,
plus the size of the libraries it uses, plus the size of the JDK.
Especially the JDK part is not negligible even in simple applications like HelloWorld.
To get a glance on what is being pulled in the image one can use <code>-H:+PrintUniverse</code> when building the native executable.</p>
</li>
<li>
<p>Some features are always included in a native executable even though they might never be actually used at run time.
An example of such a feature is garbage collection.
At compile time we can’t be sure whether an application will need to run garbage collection at run time,
so garbage collection is always included in native executables increasing their size even if not necessary.
Native executable generation relies on static code analysis to identify which code paths are reachable,
and static code analysis can be imprecise leading to more code getting into the image than what’s actually needed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is a <a href="https://github.com/oracle/graal/issues/287">GraalVM upstream issue</a>
with some interesting discussions about that topic.</p>
</div>
</div>
<div class="sect2">
<h3 id="what-version-of-mandrel-was-used-to-generate-a-binary"><a class="anchor" href="#what-version-of-mandrel-was-used-to-generate-a-binary"></a>What version of Mandrel was used to generate a binary?</h3>
<div class="paragraph">
<p>One can see which Mandrel version was used to generate a binary by inspecting the binary as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ strings target/debugging-native-1.0.0-SNAPSHOT-runner | grep GraalVM
com.oracle.svm.core.VM=GraalVM 22.0.0.2-Final Java 11 Mandrel Distribution</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="how-do-i-enable-gc-logging-in-native-executables"><a class="anchor" href="#how-do-i-enable-gc-logging-in-native-executables"></a>How do I enable GC logging in native executables?</h3>
<div class="paragraph">
<p>Executing the native executable with <code>-XX:PrintFlags=</code> prints a list of flags that can be passed to native executables.
For various levels of GC logging one may use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ./target/debugging-native-1.0.0-SNAPSHOT-runner -XX:PrintFlags=
...
  -XX:±PrintGC                                 Print summary GC information after each collection. Default: - (disabled).
  -XX:±PrintGCSummary                          Print summary GC information after application main method returns. Default: - (disabled).
  -XX:±PrintGCTimeStamps                       Print a time stamp at each collection, if +PrintGC or +VerboseGC. Default: - (disabled).
  -XX:±PrintGCTimes                            Print the time for each of the phases of each collection, if +VerboseGC. Default: - (disabled).
  -XX:±PrintHeapShape                          Print the shape of the heap before and after each collection, if +VerboseGC. Default: - (disabled).
...
  -XX:±TraceHeapChunks                         Trace heap chunks during collections, if +VerboseGC and +PrintHeapShape. Default: - (disabled).
  -XX:±VerboseGC                               Print more information about the heap before and after each collection. Default: - (disabled).</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="can-i-get-a-heap-dump-of-a-native-executable-e-g-if-it-runs-out-of-memory"><a class="anchor" href="#can-i-get-a-heap-dump-of-a-native-executable-e-g-if-it-runs-out-of-memory"></a>Can I get a heap dump of a native executable? e.g. if it runs out of memory</h3>
<div class="paragraph">
<p>Unfortunately generating heap dumps in hprof format,
which can be opened by tools such as VisualVM or Eclipse MAT,
can only be achieved with
<a href="https://www.graalvm.org/reference-manual/native-image/NativeImageHeapdump">GraalVM Enterprise Edition</a>.
Mandrel, which is based on the GraalVM Community Edition, does not have this capability.</p>
</div>
<div class="paragraph">
<p>Although Mandrel can generate debug symbols and these contain a fair amount of information about object layouts,
including what is a pointer field vs a primitive field, this information cannot be used as is to detect memory leaks or find dominator objects.
This is because it has no idea what constitutes a root pointer nor how to recursively trace pointers from those roots.</p>
</div>
</div>
<div class="sect2">
<h3 id="can-i-build-and-run-this-examples-outside-of-a-container-in-linux"><a class="anchor" href="#can-i-build-and-run-this-examples-outside-of-a-container-in-linux"></a>Can I build and run this examples outside of a container in Linux?</h3>
<div class="paragraph">
<p>Yes you can.
In fact, debugging native executables on a Linux bare metal box offers the best possible experience.
In this kind of environments, root access is not needed except to install packages required to run some debug steps,
or to enable <code>perf</code> to gather events at the kernel.</p>
</div>
<div class="paragraph">
<p>These are the packages you&#8217;ll need on your Linux environment to run through the different debugging sections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># dnf (rpm-based)
sudo dnf install binutils gdb perf perl-open
# Debian-based distributions:
sudo apt install binutils gdb perf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generating-flame-graphs-is-slow-or-produces-errors-what-can-i-do"><a class="anchor" href="#generating-flame-graphs-is-slow-or-produces-errors-what-can-i-do"></a>Generating flame graphs is slow, or produces errors, what can I do?</h3>
<div class="paragraph">
<p>There are multiple ways in which a native executable produced by Mandrel can be profiled.
All the methods require you to pass in the <code>-H:-DeleteLocalSymbols</code> option.</p>
</div>
<div class="paragraph">
<p>The method shown in this reference guide generates a binary with DWARF debug information,
runs it via <code>perf record</code> and then uses <code>perf script</code> and flame graph tooling to generate the flamegraphs.
However, the <code>perf script</code> post-processing step done on this binary can appear to be slow or can show some DWARF errors.</p>
</div>
<div class="paragraph">
<p>An alternative method to generate flame graphs is to pass in <code>-H:+PreserveFramePointer</code> when generating the native executable instead of generating the DWARF debug information.
It instructs the binary to use an extra register for the frame pointer.
This enables <code>perf</code> to do stack walking to profile the runtime behaviour.
To generate the native executable using these flags, do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative
    -Dquarkus.native.additional-build-args=-H:+PreserveFramePointer,-H:-DeleteLocalSymbols</code></pre>
</div>
</div>
<div class="paragraph">
<p>To get runtime profiling information out of the native executable, simply do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf record -F 1009 -g -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>The recommended method for generating runtime profiling information is using the debug information rather than generating a binary that preserves the frame pointer.
This is because adding debug information to the native executable build process has no negative runtime performance whereas preserving the frame pointer does.</p>
</div>
<div class="paragraph">
<p>DWARF debug info is generated in a separate file and can even be omitted in the default deployment and only be transferred and used on demand,
for profiling or debugging purposes.
Furthermore, the presence of debug info enables <code>perf</code> to show us the relevant source code lines as well,
hence it does not bloat the native executable itself.
To do that, simply call <code>perf report</code> with an extra parameter to show source code lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">perf report --stdio -F+srcline
...
83.69%     0.00%  GreetingResource.java:20 ...
...
83.69%     0.00%  AbstractStringBuilder.java:1025 ...
...
83.69%     0.00%  ArraycopySnippets.java:95 ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The performance penalty of preserving the frame pointer is due to using the extra register for stack walking,
particularly in <code>x86_64</code> compared to <code>aarch64</code> where there are less registers available.
Using this extra register reduces the number of registers that are available for other work,
which can lead to performance penalties.</p>
</div>
</div>
<div class="sect2">
<h3 id="i-think-ive-found-a-bug-in-native-image-how-can-i-debug-it-with-the-ide"><a class="anchor" href="#i-think-ive-found-a-bug-in-native-image-how-can-i-debug-it-with-the-ide"></a>I think I’ve found a bug in native-image, how can I debug it with the IDE?</h3>
<div class="paragraph">
<p>Although it is possible to remote debug processes within containers,
it might be easier to step-by-step debug native-image by installing Mandrel locally and adding it to the path of the shell process.</p>
</div>
<div class="paragraph">
<p>Native executable generation is the result of two Java processes that are executed sequentially.
The first process is very short and its main job is to set things up for the second process.
The second process is the one that takes care of most of the work.
The steps to debug one process or the other vary slightly.</p>
</div>
<div class="paragraph">
<p>Let’s discuss first how to debug the second process,
which is the one you most likely to want to debug.
The starting point for the second process is the <code>com.oracle.svm.hosted.NativeImageGeneratorRunner</code> class.
To debug this process, simply add <code>--debug-attach=*:8000</code> as an additional build time argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.additional-build-args=--debug-attach=*:8000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The starting point for the first process is the <code>com.oracle.svm.driver.NativeImages</code> class.
In GraalVM CE distributions, this first process is a binary, so debugging it in the traditional way with a Java IDE is not possible.
However, Mandrel distributions (or locally built GraalVM CE instances) keep this as a normal Java process,
so you can remote debug this process by adding the <code>--vm.agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=*:8000</code> as an additional build argument, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ./mvnw package -DskipTests -Pnative \
    -Dquarkus.native.additional-build-args=--vm.agentlib:jdwp=transport=dt_socket\\,server=y\\,suspend=y\\,address=*:8000</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="can-i-use-jfrjmc-to-debug-or-profile-native-binaries"><a class="anchor" href="#can-i-use-jfrjmc-to-debug-or-profile-native-binaries"></a>Can I use JFR/JMC to debug or profile native binaries?</h3>
<div class="paragraph">
<p><a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH170">Java Flight Recorder (JFR)</a> and
<a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control (JMC)</a>
can be used to profile native binaries since GraalVM CE 21.2.0.
However, JFR in GraalVM is currently significantly limited in capabilities compared to HotSpot.
The custom event API is fully supported, but many VM level features are unavailable.
They will be added in future releases. Current limitations are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minimal VM level events</p>
</li>
<li>
<p>No old object sampling</p>
</li>
<li>
<p>No stacktrace tracing</p>
</li>
<li>
<p>No Streaming API for JDK 17</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use JFR add the application property: <code>-Dquarkus.native.enable-vm-inspection=true</code>.
E.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./mvnw package -DskipTests -Pnative -Dquarkus.native.container-build=true \
    -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel:22.0-java11 \
    -Dquarkus.native.enable-vm-inspection=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the image is compiled, enable and start JFR via runtime flags: <code>-XX:+FlightRecorder</code> and <code>-XX:StartFlightRecording</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./target/debugging-native-1.0.0-SNAPSHOT-runner \
    -XX:+FlightRecorder \
    -XX:StartFlightRecording="filename=recording.jfr"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details on using JFR, see <a href="https://www.graalvm.org/reference-manual/native-image/JFR">here</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-17 11:27:40 +0800
</div>
</div>
</body>
</html>